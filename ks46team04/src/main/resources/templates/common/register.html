<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="">
	<meta name="author" content="">

	<title th:text="${title}"></title>

	<!-- Custom fonts for this template-->
	<link th:href="@{/vendor/fontawesome-free/css/all.min.css}" rel="stylesheet" type="text/css">
	<link
		th:href="@{https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i}"
		rel="stylesheet">

	<!-- Custom styles for this template-->
	<link th:href="@{/css/sb-admin-2.min.css}" rel="stylesheet">

</head>

<body class="bg-gradient-success">

	<div class="container">

		<div class="card o-hidden border-0 shadow-lg my-5">
			<div class="card-body p-0">
				<!-- Nested Row within Card Body -->
				<div class="row">
					<div class="col-lg-5 d-none d-lg-block bg-register-image"></div>
					<div class="col-lg-7">
						<div class="p-5">
							<div class="text-center">
								<h1 class="h4 text-gray-900 mb-4">필링굿에 오신 것을 환영합니다</h1>
								<!-- 
									아이디 	- 영문 소문자(+숫자) 6~12자 이내 (영문 소문자만으로도 가입 가능)
											- 중복 확인
									비밀번호	- 영문 소문자+숫자 8~20자 이내
									이름		- 특수 문자나 숫자가 섞이지 않도록(중요도 낮음)
									생년월일 	- 특이사항 없음
									이메일 	- 이메일 형식
									수신여부	- 체크박스 
								-->
							</div>
							<!-- 회원가입 필수 사항 - 회원 아이디,  회원 비밀번호, 회원 이름, 회원 생년월일, 회원 연락처, 회원 이메일, 회원 이메일 수신여부 -->
							<form class="user" id="registerForm" th:action="@{/common/register}" method="post">
								<div class="form-group">
									<label for="userId">아이디</label>
									<span class="required-fields">*</span>
									<input type="text" maxlength="12" class="form-control form-control-user required-form" id="userId" name="userId"
										placeholder="영문 소문자(+숫자) 6~12자 이내">
									<button type="button" class="btn btn-success" id="checkBtn"
										style="border-radius: 20px; margin-top: 8px;">중복 확인</button>
										<span class="required-text"></span>
								</div>
								<div class="form-group" style="display: none;">
									등급
									<input type="hidden" class="form-control form-control-user" id="userLevel"
										name="userLevel" value="2">
								</div>
								<div class="form-group row">
									<div class="col-sm-6 mb-3 mb-sm-0">
										<label for="userPw">비밀번호</label>
										
										<span class="required-fields">*</span>
										<input type="password" maxlength="20" class="form-control form-control-user required-form" id="userPw"
											name="userPw" placeholder="영문 소문자+숫자 8~20자 이내">
											<span class="required-text-pw"></span>
									</div>
									<div class="col-sm-6">
										<label for="userPwCheck">비밀번호 확인</label>
										
										<span class="required-fields">*</span>
										<input type="password" maxlength="20" class="form-control form-control-user required-form"
											id="userPwCheck" name="userPwCheck" placeholder="비밀번호를 한 번 더 입력해주세요">
											<span class="required-text-pw"></span>
									</div>
								</div>
								<div class="form-group">
									<label for="userName">이름</label>
									<span class="required-fields">*</span>
									<input type="text" maxlength="24" class="form-control form-control-user required-form" id="userName" name="userName"
										placeholder="예) 홍길동">
										<span class="required-text"></span>
								</div>

								<div class="form-group">
									<label for="userBirth">생년월일</label>
									<span class="required-fields">*</span>
									<input type="date" class="form-control form-control-user required-form" id="userBirth" name="userBirth"
										>
										<span class="required-text"></span>
								</div>

								<div class="form-group">
									<label for="userPhone">연락처</label>
									<span class="required-fields">*</span>
									<div class="row">
										<div class="col-sm-3 mb-3 mb-sm-0">
											<select name="userFirstTel" id="userFirstTel"
												class="form-control-plus form-control-user-plus required-form">
												<!-- 02','031','032','033','041','043','042','044','051','052','053','054','055','061','062','063','064','070 -->
												<option value="010" selected>010</option>
												<!-- 
                                                <option value="02">02</option>
                                                <option value="031">031</option>
                                                <option value="032">032</option>
                                                <option value="033">033</option>
                                                <option value="041">041</option>
                                                <option value="042">042</option>
                                                <option value="043">043</option>
                                                <option value="044">044</option>
                                                <option value="051">051</option>
                                                <option value="052">052</option>
                                                <option value="053">053</option>
                                                <option value="054">054</option>
                                                <option value="055">055</option>
                                                <option value="061">061</option>
                                                <option value="062">062</option>
                                                <option value="063">063</option>
                                                <option value="064">064</option>
                                                <option value="070">070</option> -->
											</select>
										</div>
										<div style="padding-top: 12px;">-</div>
										<div class="col-sm-3">
											<input type="text" maxlength="4" class="form-control form-control-user required-form"
												id="userSecondTel" name="userSecondTel" placeholder="0000">
												<span class="required-text"></span>
										</div>
										<div style="padding-top: 12px;">-</div>
										<div class="col-sm-3">
											<input type="text" maxlength="4" class="form-control form-control-user required-form"
												id="userThirdTel" name="userThirdTel" placeholder="0000">
										<span class="required-text"></span>
										</div>
									</div>
								</div>
								<div class="form-group">
									<label for="userEmail">이메일</label>
									<span class="required-fields">*</span>
									<input type="email" class="form-control form-control-user required-form" id="userEmail" name="userEmail" placeholder="예) email00@gmail.com ">
									<span class="required-text"></span>
								</div>
									<div class="form-group">
								    <label for="userEmailAgree" style="display: flex; align-items: center;">이메일 수신여부</label>
								    <span class="required-fields" style="margin-left: -96px;"></span>
								    <div class="form-row align-items-center search-schedule">
								        <div style="display: flex; align-items: center;">
								            <label for="userEmailAgree" style="margin-right: 5px;">수신동의</label>
								            <input type="radio" class="form-control form-control-user radio-sm required-form" id="userEmailAgree" name="userEmailAgree" value="1" checked />
								        </div>
								        <div style="padding: 0 10px;"></div>
								        <div style="display: flex; align-items: center;">
								            <label for="userEmailDisAgree" style="margin-right: 5px;">수신거부</label>
								            <input type="radio" class="form-control form-control-user radio-sm required-form" id="userEmailDisAgree" name="userEmailAgree" value="0" />
								        </div>
								    </div>
								</div>
							
								<a class="btn btn-success btn-user btn-block" id="submitBtn">
									가입하기
								</a>

							</form>
							<hr>
							<div class="text-center">
								<a class="small" th:href="@{/common/forgot-password}">비밀번호 찾기</a>
							</div>
							<div class="text-center">
								<a class="small" th:href="@{/common/login}">로그인</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Bootstrap core JavaScript-->
	<script src="/vendor/jquery/jquery.min.js"></script>
	<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

	<!-- Core plugin JavaScript-->
	<script src="/vendor/jquery-easing/jquery.easing.min.js"></script>

	<!-- Custom scripts for all pages-->
	<script src="/js/sb-admin-2.min.js"></script>
	<script type="text/javascript" th:inline="javascript">
		let isIdCheck = false; 	//아이디 중복 검사 여부를 확인하는 플래그값, submit 할 때 검사
		let isPwCheck = 0;	//비밀번호 확인 검사 여부를 확인하는 플래그값, submit 할 때 검사, 0=입력전/1=비번일치/2비번=불일치
		
		// 값 여부 체크
		function validationCheck(ele){
			let data = $(ele).val();
			let isValid = true;
			if(typeof data == 'undefined' || data == null ||
					data == '' || /\s{1,}/.test(data)){
			isValid = false;
			}
			return isValid;
		}
		
		// 아이디 중복 체크
		$('#checkBtn').click(function(){
			const $userIdEle = $('#userId');
			let userId = $userIdEle.val(); 
			console.log(userId + " <- 유저가 입력한 아이디 값");
			
			let $rqText = $userIdEle.siblings('.required-text');	//안내 메시지
			
			// (아이디 중복 체크 -) 값 여부 체크
			if(typeof userId == 'undefined' ||	userId == null ||
					userId == '' || /\s{1,}/.test(userId)){	
				$rqText.text(`*아이디를 입력해주세요`);
				$userIdEle.focus();
				return false;
			}else{	// input에 아이디가 있다면 유효성 검사			
				// 1. 아이디 양식 확인 - 영문 소문자(+숫자) 6~12자 이내 (숫자만으로는 가입이 불가능하고 영문소문자만으로는 가입이 가능)
				//let regIdForm = /^[a-z0-9]{6,12}$/;
				//let regIdForm = /^(?=.*[a-z])(?=.*[0-9])[a-z0-9]{6,12}$/; //영문소문자+숫자 무조건 포함하게 
				let regIdForm = /^(?=.*[a-z])[a-z0-9]{6,12}$/;
				
				if(userId.length >= 6 && userId.length <= 12 && regIdForm.test(userId)){		// id양식이 맞는다면
					// 2. 디비에 존재하는 id와 비교
					let request = $.ajax({
						url: '/common/useridCheck', 
						method: 'POST',
						data: {'userId' : userId},
						dataType: 'json'
					});
					
					//중복 없이 사용가능한 아이디면 request 결과 data == true
					request.done(function(checkId){
						//console.log(typeof checkId + '<- ajax 아이디 체크 메소드 실행 결과 자료형');
						//console.log(checkId + ' <- ajax 아이디 체크 결과 불린값');
						if(!checkId){
							alert('중복된 아이디입니다.');
							$userIdEle.val('');
							$userIdEle.focus();
						}else{
							// 사용가능 아이디
							alert('사용 가능한 아이디입니다.');
							isIdCheck = true;
							console.log(`${isIdCheck} <- 아이디 체크 여부`);
						}
					});
				
					request.fail(function(jqXHR, textStatus){
						alert(`Request failed: ${textStatus}`);
					});
				}else{	//아이디 양식에 맞지 않는다면
					alert('아이디 규칙이 맞지 않습니다.');
					$rqText.text(`*영문 소문자(+숫자) 6~12자 이내`);
				}	//else문 끝 - id 양식 체크
			}	//else문 끝 - input에 아이디가 있다면 유효성 검사
		});	//click function 끝
		
		
		$('#userId').change(function(){
			isIdCheck = false;
		});
		
		
		//비밀번호-------------------------
		$('#userPw').on('input', function(event){
			isPwCheck = 2;
			const $userPwEle = $('#userPw');
			let userPw = $userPwEle.val();
			let $rqTextPw = $userPwEle.siblings('.required-text-pw');
			let msg = '';
			
			console.log(userPw);
			console.log(userPw.length);
			
			let regPwFormAlpha = /^[a-z0-9]+$/;		//특수문자 포함여부만 파악
			let regPwFormLeng = /^[a-z0-9]{8,20}$/;	//글자수까지 파악
			let pwColor = 1;
			
			console.log((userPw.length < 8) + ' <- 1번');
			console.log((userPw.length > 20) + '<- 2번');
			console.log(regPwFormLeng.test(userPw)+ ' < 3번');
			if(!regPwFormAlpha.test(userPw)){
				msg = `*입력 규칙에 맞지 않습니다`;
			}else if (!/[a-z]/.test(userPw) || !/[0-9]/.test(userPw)) {
   			 	msg = `*영문 소문자와 숫자를 모두 포함해야 합니다`;
    		}else if(userPw.length < 8){
				msg = `*글자 수가 적습니다(8~20자 이내)`;
			}else if(userPw.length > 20){
				msg = `*글자 수가 많습니다(8~20자 이내)`;
			}else if(regPwFormLeng.test(userPw)){
				pwColor = 2;
				msg = `✔ 사용 가능한 비밀번호입니다`;
			}
			
			if(pwColor === 1){
				$('.pw > .required-text-pw').css("color", "red");
			}else{
				$('.pw > .required-text-pw').css("color", "green");
			}
			$rqTextPw.text(msg);
			
			pwCheck();
		});
	
		
		//비밀번호 확인-------------------------
		$('#userPwCheck').on('input', function(event){
			pwCheck();
		});
		//비밀번호 확인 함수-------------------------
		function pwCheck(){
			const $userPwEle = $('#userPw');
			let userPw = $userPwEle.val();
			
			const $userPwCheckEle = $('#userPwCheck');
			let userPwCheck = $userPwCheckEle.val();
			
			let $rqTextPwCheck = $userPwCheckEle.siblings('.required-text-pw');
			let msg = '';
			let pwColor = 1;
			
			if(typeof userPwCheck != 'undefined' &&	userPwCheck != null &&
					userPwCheck != ''){
				if(userPwCheck.length == userPw.length && userPw === userPwCheck){
					pwColor = 2;
					msg = `✔ 비밀번호가 일치합니다.`;
					isPwCheck = 1;
				}else{
					msg = `*비밀번호가 일치하지 않습니다.`;
					isPwCheck = 2;
				}
				
				if(pwColor === 1){
					$('.pwCheck > .required-text-pw').css("color", "red");
				}else{
					$('.pwCheck > .required-text-pw').css("color", "green");
				}
				$rqTextPwCheck.text(msg);
			}
		}
		//날짜 확인 -------------------------
		//170살을 넘을 수 없음. 오늘 날짜를 넘길 수 없음.
		//오늘 날짜를 파악하는 함수
		$('#userBirth').on('input', function(){
			//서버에서 한국 표준시 가져오기
			let xmlHttpRequest;
			if(window.XMLHttpRequest){// code for Firefox, Mozilla, IE7, etc.
				xmlHttpRequest = new XMLHttpRequest();
			}else if(window.ActiveXObject){// code for IE5, IE6
				xmlHttpRequest = new ActiveXObject("Microsoft.XMLHTTP");
			}else{
				return;
			}

			xmlHttpRequest.open('HEAD', window.location.href.toString(), false);
			xmlHttpRequest.setRequestHeader("ContentType", "text/html");
			xmlHttpRequest.send('');

			let serverDate = xmlHttpRequest.getResponseHeader("Date");
			const today = new Date(serverDate);
			console.log(today);
			//표준시 가져오기 end
			
			const minBirthDate = new Date(today.getFullYear() - 150, today.getMonth(), today.getDate());
			
			const selectedBirthDate = $('#userBirth').val();
			const [year, month, day] = selectedBirthDate.split('-');
			const userBirthDate = new Date(year, month-1, day);
			if (userBirthDate > today) {
			 	// 생년월일이 오늘을 넘거나
			 	alert('생년월일은 오늘을 넘길 수 없습니다.');
			 	$('#userBirth').val('');
			 	$('#userBirth').focus();
			}else if(userBirthDate < minBirthDate){
				//150살 이상을 선택
				alert('150살을 넘도록 설정하였습니다.');
				$('#userBirth').val('');
			 	$('#userBirth').focus();
			}
			
		});
		
		//연락처 입력-------------------------
		function validateFourDigitNumber(userTel) {
			console.log(userTel);
			if (/^\d{4}$/.test(userTel)) {
		    	return true;
			} else {		
				return false;
		 	}
		}
		
		$('#userSecondTel').on('blur', function(){
			const $userSecondTelEle = $('#userSecondTel');
			let userSecondTel = $('#userSecondTel').val();	
			const $rqTextPwCheck = $userSecondTelEle.siblings('.required-text');
			
			if(typeof userSecondTel != 'undefined' && userSecondTel != null &&
					userSecondTel != '' && !(/\s{1,}/.test(userSecondTel))){
				let numberCheck = validateFourDigitNumber(userSecondTel);	
				if(numberCheck == false){
					$rqTextPwCheck.text(`*번호 네 자리를 입력하세요`);
					$userSecondTelEle.val('');
					$userSecondTelEle.focus();
				}else{
					$rqTextPwCheck.text('');
				}
			}
		});
		
		$('#userThirdTel').on('blur', function(){
			const $userThirdTelEle = $('#userThirdTel');
			let userThirdTel = $('#userThirdTel').val();
			
			let $rqTextPwCheck = $userThirdTelEle.siblings('.required-text');
			
			if(typeof userThirdTel != 'undefined' && userThirdTel != null &&
					userThirdTel != '' && !(/\s{1,}/.test(userThirdTel))){
				let numberCheck = validateFourDigitNumber(userThirdTel);	
				if(numberCheck == false){
					$rqTextPwCheck.text(`*번호 네 자리를 입력하세요`);
					$userThirdTelEle.val('');
					$userThirdTelEle.focus();
				}else{
					$rqTextPwCheck.text('');
				}
			}
		});
		
		//이메일 입력-------------------------
		$('#userEmail').on('blur', function(){
			const $emailEle = $('#userEmail');
			let email = $('#userEmail').val();
			const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
			const $rqTextCheck = $emailEle.siblings('.required-text');
			
			if(emailPattern.test(email)){
				$rqTextCheck.text('');
			}else{
				$rqTextCheck.text(`*이메일 형식에 맞지 않습니다`);
			}
		});
	</script>
	
	<script>
	
		$('#submitBtn').click(function(){
			const $registerForm = $('#registerForm');
			const $requiredForm = $('#registerForm .form-group .required-form');
			let isSubmit = false;
			$requiredForm.each(function(idx, item){
				isSubmit = validationCheck(item);
				
				if(!isSubmit){
					//let msg = $(item).parents('tr').find('label').text();
					let msg = $(item).closest('.form-group').find('label').text();
					alert(msg + '은(는) 필수항목입니다');
					$(item).focus();
					return false;
				}
			});	//each문 끝
			
			if(isIdCheck == false){
				alert('아이디를 중복 체크 해주세요');
				$('#checkBtn').focus();
				return false;
			}else if(isPwCheck == 2){
				alert('비밀번호가 서로 다릅니다');
				$('#userPw').val('');
				$('#userPwCheck').val('');
				$('#userPw').focus();
				return false;
			}		
			
			console.log(isSubmit, isIdCheck, isIdCheck);
			if(isSubmit == true && isIdCheck == true && isPwCheck == 1){
				//연락처 통합 ('-')로 연결
				const userFirstTel = $('#userFirstTel').val();
				const userSecondTel = $('#userSecondTel').val();
				const userThirdTel = $('#userThirdTel').val();
				let UserTel = null; 
				UserTel = `${userFirstTel}-${userSecondTel}-${userThirdTel}`;
				console.log(UserTel);
				
				const hiddenTelNum = $('<input>').attr({
					  type: 'hidden',
					  name: 'userPhone',
					  value: UserTel,
					});
				$registerForm.append(hiddenTelNum);
				// AJAX 요청을 사용하여 폼을 서버에 제출
					    $.ajax({
					      type: 'POST',
					      url: '/common/register',
					      data: $registerForm.serialize(),
					      success: function(response) {
					        // 가입이 완료된 경우 알림을 표시
					        alert('가입이 완료되었습니다');
					        // 로그인 페이지로 이동
    						window.location.href = "/common/login";
					      },
					      error: function(xhr, status, error) {
					        // 오류 처리
					        alert('가입 중 오류가 발생했습니다');
						      }
						    });
						  }
						});
				
	

	</script>
</body>

</html>